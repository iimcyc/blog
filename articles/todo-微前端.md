# 微前端介绍与实践

## 什么是微前端

微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。

### 微前端架构具备以下几个核心价值

* 技术栈无关
* 独立开发、独立部署
* 增量升级
* 独立运行时

## qiankun

qiankun 是一个基于 single-spa 的微前端实现库，旨在帮助大家能更简单、无痛的构建一个生产可用微前端架构系统。

qiankun 孵化自蚂蚁金融科技基于微前端架构的云产品统一接入平台。

特点：

* 基于 single-spa 封装
* 技术栈无关
* HTML Entry 接入方式
* 样式隔离
* JS 沙箱
* 资源预加载
* umi 插件

### 沙箱原理

todo..

### Why Not Iframe

[Why Not Iframe](https://www.yuque.com/kuitos/gky7yw/gesexv)

### qiankun 缺点

样式冲突问题

默认情况下沙箱可以确保单实例场景子应用之间的样式隔离，但是无法确保主应用跟子应用、或者多实例场景的子应用样式隔离。

strictStyleIsolation 严格的样式隔离模式，会为每个微应用的容器包裹上一个 shadow dom 节点，会导致子应用全局样式（如 dialog）失效。

## 实践

系统使用 qiankun 框架，接入方式按功能分为两种：页面级和组件级。

### 页面级

如果使用 qiankun 自带路由，切换页面时候其他页面的实例会被销毁，所以路由缓存等功能无法实现。

所以我们主应用采用 loadMicroApp 手动加载微应用，配合主应用的权限系统路由，加载不同模块。

* 主应用权限系统配置子应用路由菜单、 url 等信息；
* loadMicroApp 手动加载微应用；
* 主应用 class 采用特殊前缀，防止与子应用样式冲突；主应用 npm 引入的有关 css 也特殊处理；
* 切换路由时，其他子应用盒子设置 display: none ；
* 切换路由时，其他子应用 style 标签设置 type="forbidden" 、 link 标签设置 type="forbidden" ref="forbidden" ，防止与活跃子应用路由冲突。

### 组件级

由于主应用的首页是由多个可配置的模块组成的，并且这些模块的开发任务来自不同的部门，大家都来修改同一个项目显得很不合理。所以我们设计了组件级子应用，集成首页。

首页的模块个数可能会很多，所以我们做了公共包的提取。这里涉及到两种情况：模块独立运行和作为子应用运行。所以实现方式是，要求开发把预设的公共包放在 html 中，通过 cdn 方式引入，并设置 qiankun 的忽略标识 ignore 。作为子应用时候，主应用传给子应用这些公共包的实例。我们还提供了代理子应用生命钩子的工具包，帮开发判断独立运行和微应用模式的公共包的使用。

特点有：

* 采用 strictStyleIsolation 严格模式样式隔离，子应用开发不需要关心样式冲突，但是不能使用插入 body 的 dialog （样式会丢失）
* 提供接入 demo ，把预设公共包用 cdn 方式引入，使用工具包代理生命钩子
* 提供平台配置微应用名称、链接等信息

## 微前端 使用场景是什么

## 为什么要用 微前端


## 微前端优点
## 微前端缺点

## 使用中的问题、瓶颈

## 心得

## 





## 参考

* https://qiankun.umijs.org/zh/guide