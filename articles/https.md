# HTTPS 的加密过程、抓包原理和范抓包策略

关键词：

对称加密、非对称加密、加密套件、 client-random 、 service-random 、 pre-master 、 master secret

数字证书、 CA 机构、数字签名、信息摘要、 Hash 函数

中间人

## 对称加密和非对称加密

对称加密：指加密和解密都使用的是相同的密钥。

非对称加密：有 A、B 两把密钥，如果你用 A 密钥来加密，那么只能使用 B 密钥来解密；反过来，如果你要 B 密钥来加密，那么只能用 A 密钥来解密。

非对称加密的效率太低。所以最终选择非对称加密加密秘钥，对称加密加密数据。

## HTTPS 加密过程

完成流程如下：

![完整的HTTPS请求流程](http://storage.icyc.cc/p/20211124/rc-upload-1637669042783-8.png)

1. 浏览器向服务器发送对称加密套件列表、非对称加密套件列表和随机数 client-random；
2. 服务器保存随机数 client-random，选择对称加密和非对称加密的套件，然后生成随机数 service-random，向浏览器发送选择的加密套件、service-random 和数字证书；
3. 浏览器验证数字证书，拿到公钥，保存公钥，并生成随机数 pre-master，然后利用公钥对 pre-master 加密，并向服务器发送加密后的数据；
4. 最后服务器拿出自己的私钥，解密出 pre-master 数据，并返回确认消息。
5. 客户端和服务端使用 client-random、service-random 和 pre-master 生成 master secret ，接下来双方就可以进行数据的对称加密传输了。

## 生成和验证数字证书

### CA 机构生成生成数字证书

网站想要申请数字证书，需要以下步骤

1. 准备一套公钥和私钥，私钥留着自己使用
2. 向 **CA 机构**提交公钥、公司、站点等信息并等待认证
3. 如果审核通过，CA 机构向网站签发**数字证书**，包含了明文的网站公钥、组织信息、CA 的信息、有效时间、证书序列号、**CA 数字签名**等

数字签名生成方式是：用 Hash 函数计算网站提交的明文信息，得到**信息摘要**，然后 CA 机构使用自己的私钥对信息摘要进行加密，得到数字签名。

### 浏览器验证数字证书

浏览器拿到数字证书中的明文信息，使用同样的 Hash 函数计算出信息摘要 A ；然后利用 CA 机构的公钥解密数字签名，得到信息摘要 B ，对比信息摘要 A 和信息摘要 B ，如果一致，则证明数字证书是合法的。

那么如何确认 CA 证书的合法性：

根 CA 机构的根证书都内置在操作系统中，根 CA 会认证很多中间的 CA ，而这些中间 CA 又可以去认证其它的中间 CA ，从而形成一条数字证书链。浏览器只要从数字证书链往上追溯到这几个根证书，浏览器会认为使用者的证书是合法的。

## 抓包原理

常用的 HTTPS 抓包方式是作为中间人，对客户端伪装成服务端，对服务端伪装成客户端。

抓包工具会在客户端上安装自己的根证书。

作为中间人，抓包工具大部分数据都是透传的，以下部分做了修改：

* 传输数字证书阶段，抓包工具把服务端的数字证书保存，把自己的数字证书发送给客户端；（由于抓包工具事先在客户端操作系统安装了自己的跟证书，所以客户端会认为抓包工具的数字证书是合法的）
* 传输 pre-master 阶段，抓包工具用自己的私钥解密出 pre-master ，用服务器的公钥加密 per-master ，然后发送给服务端；
* 接下来的数据传输过程，抓包工具就能用生成的 master secret 解密得到数据。 

## 反抓包策略

客户端内置数字证书或者公钥，建立 HTTPS 链接时比对数字证书或者公钥。
