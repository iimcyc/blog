# onlyoffice 开发

## onlyoffice 版本

社区版。

其他版本对比：https://xdqrsl5ztv.feishu.cn/docx/RJzydEDDso4DMAx3KWecRN9nnRW

## 合同用到的功能

* 获取所有修订记录
* 获取所有修订记录 json
* 接受所有修订内容
* 判断给定范围是否在页眉页脚内
* 获取所有表格 坐标
* 替换 指定两个文本内容
* 设置 指定位置文本内容
* 获取 指定位置文本内容
* 滚动页面(滚动到指定页面)
* 获取当前页数
* 获取总页数
* 保存文档
* 文档窗口变化时自动调整页面
* 设置范围
* 删除选区
* 获取内容控件对象和内容控件数量
* 获取选区范围
* 搜索文本
* 文档所有修订 接受/拒绝
* 排版到最后一页
* 文档只读/编辑模式
* 获取是否处于修订模式
* 切换文档修订/编辑模式
* 在光标位置处插入文本
* 将文档中所有控件替换成控件内的文字
* 将控件替换成控件内的文本
* 获取 WPS 文档内容
* 将指定范围滚动到可视范围
* 去除文本字体颜色 置为黑色
* 设置删除文本字体颜色
* 设置字体颜色
* 去除文本背景色 置为白色
* 设置删除文本背景色
* 设置修改文本背景色
* 设置新增文本背景色
* 设置背景色
* 显示/隐藏评论
* 删除全部评论
* 获取全部评论
* 删除评论
* 添加评论
* 删除所有标签
* 删除指定的标签
* 获取书签所在位置
* 跳转到指定书签
* 修改标签内容
* 添加书签
* 插入带输入的字段
* 指定范围是否在表格内
* 文档聚焦
* 在光标处添加控件
* addDocumentField
* getDocumentFieldNum
* 当前文档处于限制模式

## wps 和 onlyoffice 功能对比

https://xdqrsl5ztv.feishu.cn/docx/RJzydEDDso4DMAx3KWecRN9nnRW

## 开发难点

* 破解并发20限制
* 评论的显示/隐藏
* 模式切换：onlyoffice 切换 mode 会有弹框提示，需实现无感切换，或者改产品方案。
* 按坐标定位
* 获取文档，目前 onlyoffice 支持获取html

## 开发方式调研

### 插件

实现一个插件，隐藏的、自运行，插件内实现postmessage，页面和插件postmessage交互。

* 调用官方封装好的方法： ```window.Asc.plugin.executeMethod("AddComment",**)``` https://api.onlyoffice.com/plugin/executemethod/text/addcomment
* 自己实现方法： callCommand 触发 ```var oDocument = Api.GetDocument();```
* 其他功能如生成文件： 前端开发 .docbuilder 后缀模板文件，服务端接口调用。

### apps（编辑器iframe项目）

修改源码，组合调用builder实现自研功能。

### 客户端页面

使用方式：onlyoffice-editor 组件，或者 ```new window.DocsAPI.DocEditor(this.id, editorConfig)``` 自定义初始化。

交互方式：postmessage

## 2季度规划实现的功能

### 框架功能

* 集成现有插件功能，设计自研开发流程（页面与插件postmessage交互，在apps中修改源码添加功能）
* 文件生成类api开发方式，前后端交互方式（.docbuilder）
* 发版流程

### 自研功能

评论模块：

* 添加/修改/删除/获取（通过选择内容/指定范围）
* 获取/删除所有
* 定位
* 隐藏/显示（难点）

书签模块：

* 添加/修改/删除/获取（通过选择内容/指定范围）
* 获取/删除所有
* 定位

文本域/内容控件：

* 添加/修改/删除/获取（通过选择内容/指定范围）
* 获取/删除所有
* 定位

内容操作：

* 查找内容
* 选中内容（通过内容/指定范围）
* 删除内容（通过内容/指定范围）
* 替换内容（通过内容/指定范围）
* 添加内容：往最后添加、光标处添加
* 页数：获取当前页数、获取总页面、定位到指定页
* 获取文档内容
* 文档聚焦

颜色操作：

* 设置选中字体颜色
* 设置选中字体背景颜色
* 设置文本背景色

修订：

* 获取所有修订记录
* 接受/拒绝所有修订内容
* 接受/拒绝单个修订内容

模式切换：

* 是否修订
* 编辑/只读（难点）
* 获取文本状态

## 2季度里程碑

* 4月：搭建开发框架，确定开发方案，编写开发 demo 。完成前后端授权和回掉借口联调，使得后续能够投入开发。
* 5月：完成 评论模块、书签模块、文本域/内容控件模块、内容操作模块 开发工作。
* 6月：完成 颜色操作、修订、模式切换，提供测试方式，6月19号提测（距离月底10个工作日），确保月底完成工作。

人员配置：大部分工作都在前端，2个前端（根据进度调整），1个后端。

## 后期规划

* 集成文档比对功能
* 集成错别字审查功能
